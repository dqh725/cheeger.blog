<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="/images/favicon.png" itemprop="image">
  <link rel="shortcut icon" type="image/png" href="images/favicon.png"/>
  <title>OCserv on Ubuntu 16.04 for Cisco AnyConnect Client</title>
  <meta name="description" content="OCserv_with_anyconnect">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://blog.cheeger.com/2017/07/08/setup-OCserv-with-AnyConnect.html">
  <link rel="alternate" type="application/rss+xml" title="" href="http://blog.cheeger.com/feed.xml">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112429779-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-112429779-1');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <a class="site-title" href="/">阿尔巴的博客</a>
    <nav class="site-nav">
      <div class="trigger">
        
          
          <a class="page-link" href="/about/">关于我</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">OCserv on Ubuntu 16.04 for Cisco AnyConnect Client</h1>
    <p class="post-meta"><time datetime="2017-07-08T00:00:00+10:00" itemprop="datePublished">Jul 8, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1 id="ocserv_with_anyconnect">OCserv_with_anyconnect</h1>

<h2 id="ocserv-on-ubuntu-1604-for-cisco-anyconnect-client">OCserv on Ubuntu 16.04 for Cisco AnyConnect Client</h2>

<div class="entry-meta"><span class="author vcard">[<span class="fn">Ri Xu</span>](https://xuri.me/author/xuri)</span> <span class="date updated">[March 19, 2016](https://xuri.me/2016/03/19/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client.html "18:50")</span> <span class="category">[Linux](https://xuri.me/category/linux)</span> <span class="comments">[1 Comment](https://xuri.me/2016/03/19/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client.html#disqus_thread)</span></div>

<p>&lt;/div&gt;</p>

<p><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-10.png" alt="Cisco AnyConnect Secure Mobility Client" /></p>

<p><strong>Introduction</strong></p>

<p>OCserv is the OpenConnect VPN server. Its purpose is to be a secure, small, fast and configurable VPN server. It implements the OpenConnect SSL VPN protocol, and has also (currently experimental) compatibility with clients using the AnyConnect SSL VPN protocol. The OpenConnect protocol provides a dual TCP/UDP VPN channel, and uses the standard IETF security protocols to secure it. The server is implemented primarily for the GNU/Linux platform but its code is designed to be portable to other UNIX variants as well. From Ubuntu 16.04 onward, OCserv is included in the standard Ubuntu repositories, so you do not need to compile it from source. In this tutorial the iOS 9 client, which could be an iPad or an iPhone, will connect to the VPN server using the Cisco AnyConnect VPN client.</p>

<p><strong>Install packages on server</strong></p>

<p>Log on to your server and install the OCserv package:</p>

<pre>$ sudo apt-get install ocserv
</pre>

<p>We will also need the GnuTLS package, since we use the GnuTLS utilities to generate our public key infrastructure (keys and certificates):</p>

<pre>$ sudo apt-get install gnutls-bin
</pre>

<p>We can use self-signed certificates or using a purchased commercial certificate from CA certificate providers, such as <a href="https://www.comodo.com/">Comodo</a>, <a href="https://www.startssl.com/">StartSSL</a>, <a href="https://www.wosign.com/english/">WoSign</a> and etc.</p>

<p><strong>Make CA certificate and server certificate</strong></p>

<p>The GnuTLS certificate tool (<code class="highlighter-rouge">certtool</code>) allows you to specify the fields for your certificates in a configuration template file.</p>

<p>Start by creating a configuration template file for your Certificate Authority (CA) certificate:</p>

<pre>$ cd /etc/ocserv
$ sudo vim ca.tmpl
</pre>

<p>Press the <kbd>I</kbd> key on your keyboard to enter insert mode.</p>

<p>Enter the following fields into the CA configuration file, customizing the values as you prefer:</p>

<pre>cn = "My CA"
organization = "My Org"
serial = 1
expiration_days = 3650
ca
signing_key
cert_signing_key
crl_signing_key
</pre>

<p>When you have finished entering the above, escape from insert mode, write the file to disk, and quit the editor.</p>

<p>Now generate a key and certificate for your CA, using the CA configuration template file you just created:</p>

<pre>$ sudo certtool --generate-privkey --outfile ca-key.pem
$ sudo certtool --generate-self-signed --load-privkey ca-key.pem \
    --template ca.tmpl --outfile ca-cert.pem
</pre>

<p>Now create a server certificate template file:</p>

<pre>$ sudo vim server.tmpl
</pre>

<p>Press the <kbd>I</kbd> key on your keyboard to enter insert mode.</p>

<p>Enter the following fields into the server configuration file. Note that in the common name (<code class="highlighter-rouge">cn</code>) field, you must specify your actual server IP address or hostname (shown as <code class="highlighter-rouge">vpn.xuri.me</code> in the example that follows):</p>

<pre>cn = "vpn.xuri.me"
organization = "My Org"
expiration_days = 3650
signing_key
encryption_key
tls_www_server
</pre>

<p>When you have finished entering the above, escape from insert mode, write the file to disk, and quit the editor.</p>

<p>Generate the server key and certificate, using the configuration template file:</p>

<pre>$ sudo certtool --generate-privkey --outfile server-key.pem
$ sudo certtool --generate-certificate --load-privkey server-key.pem \
    --load-ca-certificate ca-cert.pem --load-ca-privkey ca-key.pem \
    --template server.tmpl --outfile server-cert.pem
</pre>

<p><strong>Use commercial certificate</strong></p>

<p>For example I use <a href="https://buy.wosign.com/free/">WoSign Free SSL Certificates</a>. I got <code class="highlighter-rouge">1_vpn.xuri.me_bundle.crt</code> and <code class="highlighter-rouge">2_vpn.xuri.me.key</code> two files. Convert <code class="highlighter-rouge">.crt</code> certificate to <code class="highlighter-rouge">.pem</code> format:</p>

<pre>$ openssl x509 -in 1_vpn.xuri.me_bundle.crt -out server-cert.pem -outform PEM
</pre>

<p>Convert <code class="highlighter-rouge">.key</code> file to <code class="highlighter-rouge">.pem</code> format:</p>

<pre>$ cat 2_vpn.xuri.me.key &gt; server-key.pem
</pre>

<p>Put <code class="highlighter-rouge">server-cert.pem</code> and <code class="highlighter-rouge">server-key.pem</code> on path <code class="highlighter-rouge">/etc/ocserv/</code>, and set file permission <code class="highlighter-rouge">600</code>.</p>

<p>If you are use CA certificates issued by StartSSL, you have got certificate <code class="highlighter-rouge">cert.crt</code> file, I some case you should create certificate chain and merge sub certificate and root certificate like this:</p>

<pre>$ wget http://cert.startssl.com/certs/ca.pem
$ wget http://cert.startssl.com/certs/sub.class1.server.ca.pem
$ cat cert.crt sub.class1.server.ca.pem ca.pem &gt; server-cert.pem
</pre>

<p><strong>Configure the OpenConnect VPN server</strong></p>

<p>Edit the OCserv sample configuration file that is provided in <code class="highlighter-rouge">/etc/ocserv</code>:</p>

<pre>$ sudo vim ocserv.conf
</pre>

<p>Use the editor to comment out (<code class="highlighter-rouge">#</code>) the default values and replace them with those shown in the example that follows:</p>

<pre>#auth = "pam[gid-min=1000]"
auth = "plain[/etc/ocserv/ocpasswd]"

#server-cert = /etc/ssl/certs/ssl-cert-snakeoil.pem
#server-key = /etc/ssl/private/ssl-cert-snakeoil.key
server-cert = /etc/ocserv/server-cert.pem
server-key = /etc/ocserv/server-key.pem

#try-mtu-discovery = false
try-mtu-discovery = true

#dns = 192.168.1.2
dns = 8.8.8.8

# Comment out all route fields
#route = 10.10.10.0/255.255.255.0
#route = 192.168.0.0/255.255.0.0
#route = fef4:db8:1000:1001::/64

#no-route = 192.168.5.0/255.255.255.0

cisco-client-compat = true
</pre>

<p>When you have finished entering the above, escape from insert mode, write the file to disk, and quit the editor.</p>

<p><strong>Create user id and password</strong></p>

<p>Generate a user id and password that you will use to authenticate from AnyConnect to OCserv. For example, if you want your user id to be <code class="highlighter-rouge">xuri</code>:</p>

<pre>$ sudo ocpasswd -c /etc/ocserv/ocpasswd xuri
</pre>

<p>You will be prompted to enter a password twice. The password will not be displayed on your terminal:</p>

<pre>Enter password:
Re-enter password:
</pre>

<p><strong>Enable packet forwarding</strong></p>

<p>Allow forwarding in the Linux kernel by editing the system control configuration file:</p>

<pre>$ sudo vim /etc/sysctl.conf
</pre>

<p>Delete the <code class="highlighter-rouge">#</code> sign at the start to uncomment the line:</p>

<pre>net.ipv4.ip_forward=1
</pre>

<p>Write the file to disk and quit the editor, and make this change active now:</p>

<pre>$ sudo sysctl -p
</pre>

<p><strong>Open firewall</strong></p>

<p>Open the server firewall for SSL:</p>

<pre>$ sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
$ sudo iptables -A INPUT -p udp --dport 443 -j ACCEPT
</pre>

<p>Enable network address translation (NAT):</p>

<pre>$ sudo iptables -t nat -A POSTROUTING -j MASQUERADE
</pre>

<p>Assuming you have already installed <code class="highlighter-rouge">iptables-persistent</code>, reconfigure it to make your changes persist across server reboots:</p>

<pre>$ sudo dpkg-reconfigure iptables-persistent
</pre>

<p><strong>Start OpenConnect VPN server</strong></p>

<p>Check that nothing is already listening on port 443:</p>

<pre>$ sudo lsof -i
</pre>

<p>The command <code class="highlighter-rouge">sudo lsof -i</code> then showed systemd listening to port 443 on IPv6. I do not know why systemd was doing this. The command <code class="highlighter-rouge">systemctl -all list-sockets</code> showed the related unit as ocserv.socket. The solution was to issue the command <code class="highlighter-rouge">sudo systemctl stop ocserv.socket</code>.</p>

<p>Start OCserv:</p>

<pre>$ sudo ocserv -c /etc/ocserv/ocserv.conf
</pre>

<p>Check that it is now listening on port 443 with the command:</p>

<pre>$ sudo netstat -tulpn | grep 443
</pre>

<p><strong>Make CA certificate available for download</strong></p>

<p>Your client such as Mac, iPad or iPhone needs to be able to validate the server certificate. To allow it to do this, you must install your CA certificate on the iPad or iPhone as a trusted root certificate. The first step in this is to make the CA certificate available for download from your server.</p>

<p>Open the firewall so that you can reach the server from a browser:</p>

<pre>$ sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
</pre>

<p>Install Apache:</p>

<pre>$ sudo apt-get install apache2
</pre>

<p>Copy the CA certificate into the web root folder:</p>

<pre>$ sudo cp /etc/ocserv/ca-cert.pem /var/www/html
</pre>

<p>Download and install CA certificate</p>

<p><strong>Connect OCserv on Mac</strong></p>

<p>Download and install <a href="https://www.cisco.com/c/en/us/support/security/anyconnect-secure-mobility-client/tsd-products-support-series-home.html">Cisco AnyConnect Secure Mobility Client</a> for OS X with last version. Add your server IP address (e.g. <code class="highlighter-rouge">vpn.xuri.me</code>):</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-1.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-1.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>Enter your username:</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-2.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-2.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>Enter your password:</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-3.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-3.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>Connect to VPN</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-4.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-4.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p><strong>Connect OCserv on mobile client</strong></p>

<p>Now go to your iOS device (iPad or iPhone).</p>

<p>Open the Safari browser.</p>

<p>Browse to the location of the CA certificate at your server’s IP address. For example, if your server is located at <code class="highlighter-rouge">vpn.xuri.me</code>, then in Safari you would browse to:</p>

<pre>http://vpn.xuri.me/ca-cert.pem
</pre>

<p>Follow the prompts to install the CA certificate as a “Profile” on your iOS 9 device.</p>

<p>Once the “Profile” (i.e., certificate) is installed, tap on Done:</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-5.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-5.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>Install AnyConnect on iOS 9 client</p>

<p>On your iPad or iPhone, open the the App Store, and search for <a href="https://itunes.apple.com/en/app/cisco-anyconnect/id392790924?mt=8">Cisco AnyConnect</a>.</p>

<p>Configure AnyConnect on iOS 9 client</p>

<p>Open the AnyConnect app.</p>

<p>Tap on Connections.</p>

<p>Tap on Add VPN Connection.</p>

<ul>
  <li>Description is whatever you want</li>
  <li>Server Address is your server IP address (e.g. <code class="highlighter-rouge">vpn.xuri.me</code>)</li>
</ul>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-6.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-6.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>Tap Save.</p>

<p>Connect to VPN</p>

<p>Now connect from your iPad or iPhone to your VPN.</p>

<p>You will be prompted to enter your username (the one you set up with <code class="highlighter-rouge">ocpasswd</code> a few minutes ago, for example, <code class="highlighter-rouge">xuri</code>):</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-7.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-7.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>You will be prompted to enter your password (the one you set up for that username when you invoked <code class="highlighter-rouge">ocpasswd</code>):</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-8.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-8.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>The AnyConnect VPN toggle goes green when you are connected:</p>

<p><a href="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-9.png" title="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client"><img src="https://xuri.me/wp-content/uploads/2016/03/ocserv-on-ubuntu-16-04-for-cisco-anyconnect-client-9.png" alt="OCserv on Ubuntu 16.04 for Cisco AnyConnect Client" /></a></p>

<p>(Also, if you log on to your server and use a command such as <code class="highlighter-rouge">sudo tail /var/log/syslog</code>, you will see messages such as <code class="highlighter-rouge">sec-mod: initiating session for user 'xuri'</code>.)</p>

<div class="ratings hreview-aggregate" data-post="2615"><span class="item"><span class="fn">OCserv on Ubuntu 16.04 for Cisco AnyConnect Client</span></span>

*   <span class="average">4.50 / 5</span> <span class="best">5</span>
*   <a title="Give 1 out of 5 stars">1 / 5</a>
*   <a title="Give 2 out of 5 stars">2 / 5</a>
*   <a title="Give 3 out of 5 stars">3 / 5</a>
*   <a title="Give 4 out of 5 stars">4 / 5</a>
*   <a title="Give 5 out of 5 stars">5 / 5</a>

<div class="meta">**4** votes, **4.50** avg. rating (**90**% score)</div>

</div>

<p><a href="https://xuri.me/tag/cisco">Cisco</a>, <a href="https://xuri.me/tag/linux-os">Linux</a>, <a href="https://xuri.me/tag/vpn">VPN</a></p>

<p>&lt;/div&gt;</p>

<ul>
  <li><a href="https://xuri.me/2016/02/28/use-ssl-sni-in-production.html"><span class="meta-nav">←</span> Use SSL SNI in Production</a></li>
  <li><a href="https://xuri.me/2016/03/22/setup-hadoop-on-ubuntu-multi-node-cluster.html">Setup Hadoop on Ubuntu (Multi-Node Cluster) <span class="meta-nav">→</span></a></li>
</ul>

<div id="disqus_thread"><iframe id="dsq-app1" name="dsq-app1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="https://disqus.com/embed/comments/?base=default&amp;f=xurionline&amp;t_i=2615%20https%3A%2F%2Fxuri.me%2F%3Fp%3D2615&amp;t_u=https%3A%2F%2Fxuri.me%2F2016%2F03%2F19%2Focserv-on-ubuntu-16-04-for-cisco-anyconnect-client.html&amp;t_e=OCserv%20on%20Ubuntu%2016.04%20for%20Cisco%20AnyConnect%20Client&amp;t_d=OCserv%20on%20Ubuntu%2016.04%20for%20Cisco%20AnyConnect%20Client%20%7C%20Ri%20Xu%20Online&amp;t_t=OCserv%20on%20Ubuntu%2016.04%20for%20Cisco%20AnyConnect%20Client&amp;s_o=default&amp;l=#version=8e4b6e0b39b37378f55ff3d3af623214" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 427px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">


    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li><a href="mailto:dqh725@gmail.com">电邮:dqh725@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/albahoo"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">albahoo</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p class="text-right">勒布朗法则：推延等于拒绝</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
